{% load wagtailcore_tags wagtailimages_tags %}

<div id="blog-route-map" style="width: 100%; height: 400px;"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.min.css" />

<script>
    document.addEventListener('DOMContentLoaded', function() {
        var map = L.map('blog-route-map').setView([0, 0], 2);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        var posts = [
            {% for post in blog_posts %}
                {% with location=post.location.first %}
                    {% if location %}
                        {
                            title: "{{ post.title|escapejs }}",
                            date: "{{ post.date|date:"Y-m-d" }}",
                            url: "{% pageurl post %}",
                            lat: {{ location.latitude }},
                            lng: {{ location.longitude }}
                        },
                    {% endif %}
                {% endwith %}
            {% endfor %}
        ];

        var markers = [];
        var latlngs = [];

        posts.forEach(function(post, index) {
            var marker = L.marker([post.lat, post.lng]).addTo(map);
            marker.bindPopup('<strong>' + post.title + '</strong><br>' + post.date + '<br><a href="' + post.url + '">Read more</a>');
            markers.push(marker);
            latlngs.push([post.lat, post.lng]);
        });

        if (markers.length > 0) {
            var group = new L.featureGroup(markers);
            map.fitBounds(group.getBounds().pad(0.1));

            var polyline = L.polyline(latlngs, {color: 'red'}).addTo(map);
        }
    });
</script>